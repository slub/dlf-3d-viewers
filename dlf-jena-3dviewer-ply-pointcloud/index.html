<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLY Point Cloud Viewer</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        #scene-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }
        #loading-indicator {
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 8px;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            z-index: 101;
        }
        #logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        #logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        #logo-container img {
            width: 120px;
            height: auto;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        #logo-container img:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

<div id="loading-indicator">Loading...</div>

<div id="scene-container"></div>

<div id="logo-container">
    <a href="https://www.3dbigdataspace.eu/" target="_blank" title="3DBigDataSpace">
        <img src="./{{viewerPath}}assets/3DBigDataSpace-Logo.png" alt="Time Machine Logo">
    </a>
</div>

<!-- Use an import map to make three.js modules easier to reference -->
<script type="importmap">
    {
        "imports": {
            "three": "./{{viewerPath}}modules/three.js-r170/build/three.module.js",
            "three/addons/":  "./{{viewerPath}}modules/three.js-r170/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { PLYLoader } from 'three/addons/loaders/PLYLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    // --- Basic Scene Setup ---
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x111111);

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 3;

    const renderer = new THREE.WebGLRenderer();
    const container = document.getElementById('scene-container');
    renderer.setSize(window.innerWidth, window.innerHeight);
    container.appendChild(renderer.domElement);

    // --- Controls ---
    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;

    // --- Lighting ---
    const ambientLight = new THREE.AmbientLight(0xffffff, 1.0);
    scene.add(ambientLight);

    // --- PLY Loader ---
    const loader = new PLYLoader();
    let currentModel = null;

    function loadModel(url) {
        document.getElementById('loading-indicator').style.display = 'block';

        loader.load(
            url,
            // onLoad callback
            function (geometry) {
                // Remove the old model if it exists
                if (currentModel) {
                    scene.remove(currentModel);
                }

                // Create a material for the points
                const material = new THREE.PointsMaterial({
                    size: 0.01,
                    vertexColors: geometry.hasAttribute('color') // Use vertex colors if they exist in the file
                });

                // Create the Points object (the point cloud)
                const points = new THREE.Points(geometry, material);

                // Center and scale the model
                geometry.center();
                geometry.computeBoundingSphere();
                const scaleFactor = 1.5 / geometry.boundingSphere.radius;
                points.scale.set(scaleFactor, scaleFactor, scaleFactor);

                scene.add(points);
                currentModel = points;
                document.getElementById('loading-indicator').style.display = 'none';
            },
            // onProgress callback (optional)
            undefined,
            // onError callback
            function (error) {
                alert('An error happened while loading the model: ' + error);
                document.getElementById('loading-indicator').style.display = 'none';
            }
        );
    }

    // --- Animation Loop ---
    function animate() {
        requestAnimationFrame(animate);
        controls.update(); // Required for damping
        renderer.render(scene, camera);
    }
    animate();

    // --- Event Listeners & Auto-loading ---
    // Handle window resizing
    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // Auto-load model from URL parameter on page load
    const urlParams = new URLSearchParams(window.location.search);
    const modelUrl = urlParams.get('model');

    if (modelUrl) {
        loadModel(modelUrl);
    } else {
        const indicator = document.getElementById('loading-indicator');
        indicator.textContent = 'No model URL provided. Use "?model=URL_TO_PLY" in the address.';
        indicator.style.display = 'block';
        indicator.style.backgroundColor = 'rgba(255, 255, 255, 0.9)';
        indicator.style.color = '#333';
    }
</script>
</body>
</html>
