
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3Drepo.eu Gaussian Splat Viewer</title>
    <style>
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f0f0;
            color: #333;
        }
        #scene-container {
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: -1;
        }
        #loading-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: monospace;
            font-size: 24px;
            z-index: 101;
            display: none;
        }
        #logo-container {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 100;
        }
        #logo-container img {
            width: 120px;
            height: auto;
            opacity: 0.9;
            transition: opacity 0.2s;
        }
        #logo-container img:hover {
            opacity: 1;
        }
    </style>
</head>
<body>

<div id="logo-container">
    <a href="https://www.3dbigdataspace.eu/" target="_blank" title="3DBigDataSpace">
        <img src="./{{viewerPath}}assets/3DBigDataSpace-Logo.png" alt="Time Machine Logo">
    </a>
</div>

<canvas></canvas>

<!-- Use an import map to make three.js modules easier to reference -->
<script type="importmap">
    {
        "imports": {
            "three": "./{{viewerPath}}modules/three.js-r170/build/three.module.js",
            "three/addons/":  "./{{viewerPath}}modules/three.js-r170/examples/jsm/",
            "@lumaai/luma-web": "https://unpkg.com/@lumaai/luma-web@0.2.0/dist/library/luma-web.module.js"
        }
    }
</script>

<script type="module">
    import { WebGLRenderer, PerspectiveCamera, Scene } from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { LumaSplatsThree } from '@lumaai/luma-web';

    const canvas = document.querySelector('canvas');
    const loadingIndicator = document.getElementById('loading-indicator');

    const renderer = new WebGLRenderer({
        canvas: canvas,
        antialias: false
    });

    const scene = new Scene();

    const camera = new PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.z = 2;

    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;

    let currentSplat = null;

    function loadSplat(url) {
        if (!url) {
            console.error("No URL provided for Gaussian Splat.");
            loadingIndicator.textContent = 'Error: No URL provided.';
            loadingIndicator.style.display = 'block';
            return;
        }

        // Clean up previous splat if it exists
        if (currentSplat) {
            scene.remove(currentSplat);
            if (typeof currentSplat.dispose === 'function') {
                currentSplat.dispose();
            }
        }

        currentSplat = new LumaSplatsThree(url);
        scene.add(currentSplat);
    }

    function getUrlToLoad() {
        const params = new URLSearchParams(window.location.search);
        // Prefer a standard `url` query parameter
        const urlFromQuery = params.get('model');
        if (urlFromQuery) {
            return urlFromQuery;
        }

        // Support the old format where the URL is the entire query string
        const queryString = window.location.search;
        if (queryString.length > 1 && !params.has('model')) {
            const legacyUrl = decodeURIComponent(queryString.slice(1));
            // Simple check to see if it looks like a URL
            if (legacyUrl.startsWith('http')) {
                return legacyUrl;
            }
        }

        // Fallback to a hardcoded default value if no URL is provided
        return "https://huggingface.co/datasets/dylanebert/3d-gaussian-splatting/resolve/main/bonsai/point_cloud/iteration_30000/point_cloud.ply";
    }

    renderer.setAnimationLoop(() => {
        controls.update();
        renderer.render(scene, camera);
    });

    // Event Listeners
    window.addEventListener('resize', () => {
        renderer.setSize(window.innerWidth, window.innerHeight, false);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
    });

    // Initial setup
    function init() {
        renderer.setSize(window.innerWidth, window.innerHeight, false);
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();

        const initialUrl = getUrlToLoad();
        console.log(initialUrl);
        loadSplat(initialUrl);
    }

    init();
</script>
